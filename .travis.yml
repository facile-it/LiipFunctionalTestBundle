language: php

php:
  - 7.1
  - 7.2
  - 7.3
  - 7.4

cache:
  directories:
    - $HOME/.composer/cache

stages:
  - Test
  - Code style & static analysis

before_install:
  - phpenv config-rm xdebug.ini || echo "Unable to remove xDebug"
  - if [[ $TRAVIS_PHP_VERSION = '7.1' ]]; then export SYMFONY_DEPRECATIONS_HELPER=disabled; fi
  - if [ "$SYMFONY_VERSION" != "" ]; then composer config extra.symfony.require ^${SYMFONY_VERSION}; fi

install:
  - composer update --no-interaction --no-suggest --prefer-dist --prefer-stable

script: 
  - vendor/bin/phpunit

jobs:
  include:
    - name: Prefer lowest
      php: 7.1
      env:
        SYMFONY_DEPRECATIONS_HELPER: disabled
      install:
        - composer update --prefer-lowest --no-interaction --no-suggest --prefer-dist --prefer-stable
    - env:
        SYMFONY_VERSION: 3.4
    - env:
        SYMFONY_VERSION: 4.4
    - env:
        SYMFONY_VERSION: 5
    - name: Code coverage
      php: 7.3
      before_install: []
      script:
        - vendor/bin/phpunit --verbose --coverage-clover=build/logs/clover.xml
      after_success:
        - vendor/bin/php-coveralls -v
    - stage: Code style & static analysis
      name: PHP CS Fixer
      script: vendor/bin/php-cs-fixer fix --verbose --diff --dry-run
    - name: PHPStan
      script: vendor/bin/phpstan analyze
